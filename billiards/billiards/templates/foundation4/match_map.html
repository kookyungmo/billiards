{% extends "foundation4/base.html" %}
{% block header %}
{% load staticfiles %}
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=5aaddbae69513573cd7f693bbdcbe12a"></script>
<script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/changeMore.js"></script>
<!-- foundation datepicker start -->
<script src="{% static "js/foundation-datepicker.js" %}"></script>
<link rel="stylesheet" href="{% static "css/foundation-datepicker.css" %}">
<!-- foundation end -->
{% endblock %}
{% load extras %}
{% block content %}
	<div class="row">
		<div id="matchlist" class="large-3 columns">
			<table class="table">
				<thead>
					<tr>
						<th>比赛日历: </th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><input type="text" class="span2" value="{% now "Y-m-d" %}" id="dp1">-
						</td>
					</tr>
					<tr>
						<td><input type="text" class="span2" value="{{ enddate|date:"Y-m-d" }}" id="dp2"></td>
					</tr>
				</tbody>
			</table>
			<hr>
			{% for match in matches %}
			<div class="panel">
                <h5><a name="match" point="{{ match.poolroom.lng }},{{ match.poolroom.lat }}" match="{{ match|tojson }}" ><strong>{{ match.poolroom.name }}</strong></a></h5>
                <h6 class="subheader">￥{{ match.bonus }}</h6>
                <h6 class="subheader">{{ match.starttime }}</h6>
           	</div>
			{% endfor %}
		</div>
		<div class="large-9 columns">
			<div id="baidumap"
				style="overflow: hidden; margin: 0;"></div>
		</div>
	</div>
{% endblock %}
{% block footer %}
{% load staticfiles %}
	<script>
		var map = new BMap.Map("baidumap"); // 创建Map实例
		var matchInfo = function(marker, name, matches){			
			(function(){
				var info = {
					open: function(type, target){
						map.removeEventListener("moveend", info.open);
						map.removeEventListener("tilesloaded", info.open);
						var content = name;
						for (var idx in matches) {
							content += "<p><p/><strong>奖金: "
							+ matches[idx].fields.bonus + "</strong><br/><strong>比赛时间: " +
							matches[idx].fields.starttime + "</strong></p>";
						}
						var infoWindow = new BMap.InfoWindow(content);
						marker.openInfoWindow(infoWindow);
						infoWindow.redraw();
					}
				}
				map.addEventListener("moveend", info.open);
				map.addEventListener("tilesloaded", info.open);
			})();
			map.centerAndZoom(marker.getPosition(), 16);
		};

		function addMarker(point, iconpath) {
			var icon = new BMap.Icon(iconpath,
					new BMap.Size(39, 55), {
				    anchor: new BMap.Size(15, 53),
				    infoWindowAnchor: new BMap.Size(15, 0)
			});
			var marker = new BMap.Marker(point,{
				icon: icon
			});
			map.addOverlay(marker);
			return marker;
		}

		function addMatchMarker(i, obj) {
			var points = $(obj).attr("point").split(",");
	    	var match = eval($(obj).attr("match"));
			point = new BMap.Point(points[0], points[1]);
			var mk = addMarker(point, '{% static "images/marker.png" %}');
			mk.addEventListener("click", function() {
				matchInfo(mk, match[0].fields.poolroom.name, match);
			});
		}

		var convertCallback;
		var callback = function(xyResults) {
				var convertedPoints = [];
				var xyResult = null;
				for(var index in xyResults){
					xyResult = xyResults[index];
				  	if(xyResult.error != 0){continue;}//TODO
				  	var point = new BMap.Point(xyResult.x, xyResult.y);
				  	convertedPoints.push(point);
				}
				if (convertCallback != null)
					convertCallback(convertedPoints);
		}
		function convertPoints(points, myConvertcallback) {
			(function() {
				setTimeout(function(){
					convertCallback = myConvertcallback;
		    		BMap.Convertor.transMore(points,2, callback);
				}, 100);
			})();
		}
		
		function createMatchMarker(i, obj) {
			addMatchMarker(i, obj);
			$(obj).mouseover(function() {
				markerDo($(this).attr("point"), function(marker){
					marker.setAnimation(BMAP_ANIMATION_BOUNCE);
					  (function(){
						  setTimeout(function() {
							  marker.setAnimation(null);
							}, 2000);
					  })();
				});
			}, function() {});
			$(obj).click(function(){
				var link = $(this);
				(function() {
					markerDo(link.attr("point"), function(marker){
						matchInfo(marker, link.find("strong").text(), eval(link.attr("match")));
					});
				})();
			});
		}

		function updatePoint() {
			var ggpoints = [];
			$("a[name=match]").each(function(i, obj) {
				var points = $(obj).attr("point").split(",");
				point = new BMap.Point(points[0], points[1]);
				ggpoints.push(point);
		    });
			convertPoints(ggpoints, function(convertedPoints){
				(function() {
					$("a[name=match]").each(function(i, obj) {
						$(obj).attr("point", convertedPoints[i].lng + "," + convertedPoints[i].lat);
						createMatchMarker(i, obj);
					});
				})();
			});
		}

		$(document).ready(
				function() {
				    $("#baidumap").css("height", $(window).height() - $("#nav").outerHeight(true) - $("#banner").outerHeight(true) - $("#footer").outerHeight(true));
				    map.addControl(new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT, type: BMAP_NAVIGATION_CONTROL_SMALL}));
					map.enableScrollWheelZoom(true);
				    map.centerAndZoom('北京');

				    var geolocation = new BMap.Geolocation();
				    geolocation.getCurrentPosition(function(r){
				        if(this.getStatus() == BMAP_STATUS_SUCCESS){
				            var marker = addMarker(r.point, '{% static "images/location.png" %}');
				            marker.setTitle('我的位置');
				            map.panTo(r.point);
				        }
				        else {
				            //TODO
				        }
				    },{enableHighAccuracy: true});

				    //initial map markers
				    updatePoint();
				});

		function markerDo(pointstr, callback) {
			var points = pointstr.split(',');
			var point = new BMap.Point(points[0], points[1]);
			var overlays = map.getOverlays();
			for (var m in overlays) {
				if (overlays[m] instanceof BMap.Marker && overlays[m].getPosition().equals(point)) {
					callback(overlays[m]);
					break;
				}
			}
		}
		
		function objectToJsonString(obj) {
			var jsonstring = JSON.stringify(obj);
			return jsonstring
				.replace(/[\&]/g, '&amp;')
				.replace(/[\<]/g, '&lt;')
				.replace(/[\>]/g, '&gt;')
				.replace(/[\"]/g, '&quot;')
				.replace(/[\']/g, '&#39;');
		}

		$(function () {
			// implementation of disabled form fields
			var nowTemp = new Date();
			var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
			var dp1 = $('#dp1').fdatepicker({
				format: 'yyyy-mm-dd',
				onRender: function (date) {
					return date.valueOf() < now.valueOf() ? 'disabled' : '';
				}
			}).on('changeDate', function (ev) {
				if (ev.date.valueOf() > dp2.date.valueOf()) {
					var newDate = new Date(ev.date)
					newDate.setDate(newDate.getDate() + 14);
					dp2.setValue(newDate);
				}
				dp1.hide();
				$('#dp2')[0].focus();
			}).data('datepicker');
			var dp2 = $('#dp2').fdatepicker({
				format: 'yyyy-mm-dd',
				onRender: function (date) {
					return date.valueOf() <= dp1.date.valueOf() ? 'disabled' : '';
				}
			}).on('changeDate', function (ev) {
				dp2.hide();
				$.ajax({
					url : "{% url match_map map %}",
					data : {'f':'json', 'starttime':dp1.date.valueOf(), 'endtime': dp2.date.valueOf()},
					dataType : 'json',
					success : function(data)
					{
						function cleanMatchMarkers() {
							var overlays = map.getOverlays();
							for (var m in overlays) {
								if (overlays[m] instanceof BMap.Marker && overlays[m].getTitle() != '我的位置') {
									map.removeOverlay(overlays[m]);
								}
							}
						}

						if (data.length == 0) {
							if($("#nomatch").length == 0) {
								$("#matchlist").children(".panel").remove();
								jQuery('<div/>', {
								    id: 'nomatch',
								    class: 'panel'
								}).appendTo('#matchlist');
								jQuery('<h5/>', {
								    text: '您选择的时间段没有比赛。请重新选择。'
								}).appendTo('#nomatch');
								cleanMatchMarkers();
							}
						} else {
							$("#matchlist").children(".panel").remove();
							var ggpoints = [];
							for (var idx in data) {
								ggPoint = new BMap.Point(data[idx].fields.poolroom.lng, data[idx].fields.poolroom.lat);
								ggpoints.push(ggPoint);
							}
							convertPoints(ggpoints, function(convertedPoints){
								cleanMatchMarkers();
								for (var idx in data) {
									match = data[idx];
									var matchobj = jQuery('<div/>', {
									    class: 'panel'
									});
							    	matchobj.append("<h5><a name=\"match\" point=\"" + convertedPoints[idx].lng
							    			+ "," + convertedPoints[idx].lat + "\" match=\"" + objectToJsonString([match])
							    			+ "\"><strong>" + match.fields.poolroom.name + "</strong></a></h5>");
							    	matchobj.append("<h6 class=\"subheader\">￥" + match.fields.bonus + "</h6>");
							    	matchobj.append("<h6 class=\"subheader\">" + match.fields.starttime + "</h6>");
							    	matchobj.appendTo('#matchlist');
							    	
							    	createMatchMarker(idx, matchobj.find("a"));
								}
							});
						}
					}
				});
			}).data('datepicker');
		});
	</script>
	<div class="datepicker datepicker-dropdown dropdown-menu" style="display: none; top: 336.1875px; left: 496.5px; z-index: 10;"><div class="datepicker-days" style="display: block;"><table class=" table-condensed"><thead><tr><th class="prev" style="visibility: visible;"><i class="icon-chevron-left"></i></th><th colspan="5" class="date-switch">February 2012</th><th class="next" style="visibility: visible;"><i class="icon-chevron-right"></i></th></tr><tr><th class="dow">Su</th><th class="dow">Mo</th><th class="dow">Tu</th><th class="dow">We</th><th class="dow">Th</th><th class="dow">Fr</th><th class="dow">Sa</th></tr></thead><tbody><tr><td class="day   old">29</td><td class="day   old">30</td><td class="day   old">31</td><td class="day  ">1</td><td class="day  ">2</td><td class="day  ">3</td><td class="day  ">4</td></tr><tr><td class="day  ">5</td><td class="day  ">6</td><td class="day  ">7</td><td class="day  ">8</td><td class="day  ">9</td><td class="day  ">10</td><td class="day  ">11</td></tr><tr><td class="day  ">12</td><td class="day  ">13</td><td class="day  ">14</td><td class="day  ">15</td><td class="day   active">16</td><td class="day  ">17</td><td class="day  ">18</td></tr><tr><td class="day  ">19</td><td class="day  ">20</td><td class="day  ">21</td><td class="day  ">22</td><td class="day  ">23</td><td class="day  ">24</td><td class="day  ">25</td></tr><tr><td class="day  ">26</td><td class="day  ">27</td><td class="day  ">28</td><td class="day  ">29</td><td class="day   new">1</td><td class="day   new">2</td><td class="day   new">3</td></tr><tr><td class="day   new">4</td><td class="day   new">5</td><td class="day   new">6</td><td class="day   new">7</td><td class="day   new">8</td><td class="day   new">9</td><td class="day   new">10</td></tr></tbody><tfoot><tr><th colspan="7" class="today" style="display: none;">Today</th></tr></tfoot></table></div><div class="datepicker-months" style="display: none;"><table class="table-condensed"><thead><tr><th class="prev" style="visibility: visible;"><i class="icon-chevron-left"></i></th><th colspan="5" class="date-switch">2012</th><th class="next" style="visibility: visible;"><i class="icon-chevron-right"></i></th></tr></thead><tbody><tr><td colspan="7"><span class="month">Jan</span><span class="month active">Feb</span><span class="month">Mar</span><span class="month">Apr</span><span class="month">May</span><span class="month">Jun</span><span class="month">Jul</span><span class="month">Aug</span><span class="month">Sep</span><span class="month">Oct</span><span class="month">Nov</span><span class="month">Dec</span></td></tr></tbody><tfoot><tr><th colspan="7" class="today" style="display: none;">Today</th></tr></tfoot></table></div><div class="datepicker-years" style="display: none;"><table class="table-condensed"><thead><tr><th class="prev" style="visibility: visible;"><i class="icon-chevron-left"></i></th><th colspan="5" class="date-switch">2010-2019</th><th class="next" style="visibility: visible;"><i class="icon-chevron-right"></i></th></tr></thead><tbody><tr><td colspan="7"><span class="year old">2009</span><span class="year">2010</span><span class="year">2011</span><span class="year active">2012</span><span class="year">2013</span><span class="year">2014</span><span class="year">2015</span><span class="year">2016</span><span class="year">2017</span><span class="year">2018</span><span class="year">2019</span><span class="year old">2020</span></td></tr></tbody><tfoot><tr><th colspan="7" class="today" style="display: none;">Today</th></tr></tfoot></table></div><a class="button datepicker-close small alert right" style="width:auto;"><i class="icon-remove"></i></a></div>
{% endblock %}