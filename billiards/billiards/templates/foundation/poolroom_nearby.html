{% extends "foundation/base.html" %}
{% block header %}
{% load staticfiles %}
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=5aaddbae69513573cd7f693bbdcbe12a"></script>
<script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/changeMore.js"></script>
<script src="{% static "js/moment-with-langs.min.js" %}"></script>
<script language="javascript">var STATIC_URL = "{{ STATIC_URL|escapejs }}";</script>
<script src="{% static "js/map.js" %}?{{buildid}}"></script>
<script src="{% static "js/map_v2.js" %}?{{buildid}}"></script>
<link rel="stylesheet" href="{% static "css/map.css" %}?{{buildid}}">
{% endblock %}
{% load extras %}
{% block content %}
	<div id="poolroomlist" class="small-12 columns">
		<div class="row">
			<h2>附近的球房</h2>
		</div>
		<div class="row">
			<div id="baidumap"
						style="overflow: hidden; margin: 0;"></div>
		</div>
		<hr>
		<div class="row">
			<div id="info" class="panel">
				<h3 class="subheader">正在获取您的位置...</h3>
			</div>
		</div>
	</div>
{% endblock %}
{% block script %}
	<script>
	var map = initialMap("baidumap");
	$("#baidumap").css("height", 350);
	map.centerAndZoom('北京');
	$(document).ready(
			function() {
			    var geolocation = new BMap.Geolocation();
			    geolocation.getCurrentPosition(function(r){
			        if(this.getStatus() == BMAP_STATUS_SUCCESS){
                       	mypoint = r.point;
			            addMyLocation(mypoint);
                       	addCustomToolbar(map, mypoint);
                       	if (map.getBounds().containsPoint(mypoint)) {
			            	map.panTo(mypoint);
                       	}
			            $("#info .subheader").text("正在加载附近的球房...");
			            url = "{% url poolroom_nearby_point '00.00' '11.11' %}";
			            $.ajax({
							url : url.replace(/00\.00/g, mypoint.lat).replace(/11\.11/g, mypoint.lng),
							data : {'f':'json'},
							dataType : 'json',
							success : function(data)
							{
								if (data.length == 0) {
									$("#info .subheader").text("真遗憾，您附近没有我们收录的球房。");
								} else {
									POOLROOM_URL = "{% url poolroom_detail '000' %}";
									$("#info").remove();
									addPoolroom(data, mypoint);
								}
							},
							error: function (xhr, ajaxOptions, thrownError) {
								$("#info .subheader").text("无法获取周边的球房，请刷新重试。");
						     }
						});
			        }
			        else {
			        	$("#info .subheader").text("无法获取您当前的位置，请刷新页面重试。");
			        }
			    },{enableHighAccuracy: false});
			});
	</script>
{% endblock %}	
