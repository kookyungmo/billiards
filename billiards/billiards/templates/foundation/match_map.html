{% extends "foundation/base.html" %}
{% block header %}
{% load staticfiles %}
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=5aaddbae69513573cd7f693bbdcbe12a"></script>
<script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/changeMore.js"></script>
<!-- foundation datepicker start -->
<script src="{% static "js/foundation-datepicker.js" %}"></script>
<link rel="stylesheet" href="{% static "css/foundation-datepicker.css" %}">
<!-- foundation end -->
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.4.0/moment.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.4.0/lang/zh-cn.js"></script>
<script language="javascript">var STATIC_URL = "{{ STATIC_URL|escapejs }}"; var MOREINFO_URL = "{% url poolroom_moreinfo '000' %}"</script>
<script src="{% static "js/map.js" %}"></script>
<link rel="stylesheet" href="{% static "css/map.css" %}">
{% endblock %}
{% load extras %}
{% block content %}
	<div id="calendar" class="row">
		<dl id="calendar-per-day" class="sub-nav">
			<script>
				function addMonth(monthstr) {
					var monthItem = jQuery('<dt/>', {});
					monthItem.append("<strong><sup>" + monthstr + "</sup></strong>");
					monthItem.appendTo($(".sub-nav"));
				}

				var starttime = moment("{{ startdate|date:"D d M Y" }}");
				var endtime = moment("{{ enddate|date:"D d M Y" }}");
				var bonussummary = {};
				var bonusobj = eval('{{ bonussummary|safe }}');
				for (var idx in bonusobj) {
					bonussummary[bonusobj[idx].starttime] = bonusobj[idx].bonus;
				}
				var summary = {};
				{% for k,v in matchsummary.items %}
				summary['{{ k }}'] = {{ v }};
				{% endfor %}
				var m = moment();
				var thismonth = m.month();
				addMonth(m.lang('zh_CN').format('MMM'));
				for (var i = 0; i < {{ intervals }}; i++) {
					if (m.month() != thismonth) {
						addMonth(m.lang('zh_CN').format('MMM'));
						thismonth = m.month();
					}
					var dayItem = jQuery('<dd/>', {});
					if (m.date() == starttime.date() && m.month() == starttime.month())
						dayItem.attr('class', 'active');
					contentTemplate = "<h5><a href=\"javascript:void(0);\" timestamp=\"" + m.valueOf() + "\">" + m.date() + "</a>";
 					var formattedday = m.format("YYYY-MM-DD");
					if (formattedday in summary) {
						contentTemplate += "<sub><span data-tooltip=\"\" class=\"has-tip tip-top noradius\" title=\"当日比赛场数\">" + summary[formattedday] + "</span></sub>";
					}
					if (formattedday in bonussummary) {
						contentTemplate += "<span data-tooltip=\"\" class=\"has-tip tip-top noradius\" title=\"最高的奖金\"><sup>\
							<img src=\"{% static "images/bonus.jpeg" %}\"><sup></span>";
					}
					contentTemplate += "</h5>";
					dayItem.append(contentTemplate);
					dayItem.appendTo($(".sub-nav"));
					m.add('days', 1);
				}
			</script>
        </dl>
        <hr>
	</div>
	<div class="row">
		<div id="matchlist" class="large-7 columns">
		  	<script>
			{% if matches|length > 0 %}
				matches = eval('{{ matches|matchtojson|safe }}');
				addMatchItems(matches);
			{% else %}
	           	createNoMatch();
			{% endif %}
			</script>
		</div>
		<div class="large-5 columns">
			<div id="baidumap"
				style="overflow: hidden; margin: 0;"></div>
		</div>
	</div>
{% endblock %}
{% block footer %}
{% load staticfiles %}
	<script>
		var map = new BMap.Map("baidumap");
		$(document).ready(
				function() {
				    $("#baidumap").css("height", $(window).height() - $("#calendar").outerHeight(true) - $("#nav").outerHeight(true) - $("#banner").outerHeight(true) - $("#footer").outerHeight(true));
				    map.addControl(new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT, type: BMAP_NAVIGATION_CONTROL_SMALL}));
					map.enableScrollWheelZoom(true);
				    map.centerAndZoom('北京');

				    var geolocation = new BMap.Geolocation();
				    geolocation.getCurrentPosition(function(r){
				        if(this.getStatus() == BMAP_STATUS_SUCCESS){
				            var marker = addMarker(r.point, '{% static "images/location.png" %}');
				            marker.setTitle('我的位置');
				            map.panTo(r.point);
				        }
				        else {
				            //TODO
				        }
				    },{enableHighAccuracy: true});
				});

		$("dl dd a").click(function() {
			selectedItem = $(this);
			timestamp = selectedItem.attr('timestamp');
			selecteddate = moment(timestamp);
			$.ajax({
				url : "{% url match_map 'map' %}",
				data : {'f':'json', 'starttime':timestamp, 'endtime': selecteddate.add('days', 1).valueOf()},
				dataType : 'json',
				success : function(data)
				{
					$("dl dd.active").each(function() {
						$(this).removeClass("active");
					});
					selectedItem.parents("dd").attr('class', 'active');
					addMatchItems(data);
				}
			});
		});
	</script>
	<div class="datepicker datepicker-dropdown dropdown-menu" style="display: none; top: 336.1875px; left: 496.5px; z-index: 10;"><div class="datepicker-days" style="display: block;"><table class=" table-condensed"><thead><tr><th class="prev" style="visibility: visible;"><i class="icon-chevron-left"></i></th><th colspan="5" class="date-switch">February 2012</th><th class="next" style="visibility: visible;"><i class="icon-chevron-right"></i></th></tr><tr><th class="dow">Su</th><th class="dow">Mo</th><th class="dow">Tu</th><th class="dow">We</th><th class="dow">Th</th><th class="dow">Fr</th><th class="dow">Sa</th></tr></thead><tbody><tr><td class="day   old">29</td><td class="day   old">30</td><td class="day   old">31</td><td class="day  ">1</td><td class="day  ">2</td><td class="day  ">3</td><td class="day  ">4</td></tr><tr><td class="day  ">5</td><td class="day  ">6</td><td class="day  ">7</td><td class="day  ">8</td><td class="day  ">9</td><td class="day  ">10</td><td class="day  ">11</td></tr><tr><td class="day  ">12</td><td class="day  ">13</td><td class="day  ">14</td><td class="day  ">15</td><td class="day   active">16</td><td class="day  ">17</td><td class="day  ">18</td></tr><tr><td class="day  ">19</td><td class="day  ">20</td><td class="day  ">21</td><td class="day  ">22</td><td class="day  ">23</td><td class="day  ">24</td><td class="day  ">25</td></tr><tr><td class="day  ">26</td><td class="day  ">27</td><td class="day  ">28</td><td class="day  ">29</td><td class="day   new">1</td><td class="day   new">2</td><td class="day   new">3</td></tr><tr><td class="day   new">4</td><td class="day   new">5</td><td class="day   new">6</td><td class="day   new">7</td><td class="day   new">8</td><td class="day   new">9</td><td class="day   new">10</td></tr></tbody><tfoot><tr><th colspan="7" class="today" style="display: none;">Today</th></tr></tfoot></table></div><div class="datepicker-months" style="display: none;"><table class="table-condensed"><thead><tr><th class="prev" style="visibility: visible;"><i class="icon-chevron-left"></i></th><th colspan="5" class="date-switch">2012</th><th class="next" style="visibility: visible;"><i class="icon-chevron-right"></i></th></tr></thead><tbody><tr><td colspan="7"><span class="month">Jan</span><span class="month active">Feb</span><span class="month">Mar</span><span class="month">Apr</span><span class="month">May</span><span class="month">Jun</span><span class="month">Jul</span><span class="month">Aug</span><span class="month">Sep</span><span class="month">Oct</span><span class="month">Nov</span><span class="month">Dec</span></td></tr></tbody><tfoot><tr><th colspan="7" class="today" style="display: none;">Today</th></tr></tfoot></table></div><div class="datepicker-years" style="display: none;"><table class="table-condensed"><thead><tr><th class="prev" style="visibility: visible;"><i class="icon-chevron-left"></i></th><th colspan="5" class="date-switch">2010-2019</th><th class="next" style="visibility: visible;"><i class="icon-chevron-right"></i></th></tr></thead><tbody><tr><td colspan="7"><span class="year old">2009</span><span class="year">2010</span><span class="year">2011</span><span class="year active">2012</span><span class="year">2013</span><span class="year">2014</span><span class="year">2015</span><span class="year">2016</span><span class="year">2017</span><span class="year">2018</span><span class="year">2019</span><span class="year old">2020</span></td></tr></tbody><tfoot><tr><th colspan="7" class="today" style="display: none;">Today</th></tr></tfoot></table></div><a class="button datepicker-close small alert right" style="width:auto;"><i class="icon-remove"></i></a></div>
{% endblock %}