{% extends "foundation/base.html" %}
{% block header %}
{% load staticfiles %}
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=5aaddbae69513573cd7f693bbdcbe12a"></script>
<script src="{% static "js/moment-with-langs.min.js" %}"></script>
<script language="javascript">var STATIC_URL = "{{ STATIC_URL|escapejs }}"; var MEDIA_URL = "{{ MEDIA_URL }}";</script>
<script src="{% static "js/map.js" %}?{{buildid}}"></script>
<script src="{% static "js/map_v2.js" %}?{{buildid}}"></script>
<link rel="stylesheet" href="{% static "css/map.css" %}?{{buildid}}">
{% endblock %}
{% load extras %}
{% block content %}
	<div id="calendar" class="medium-2 small-10 small-centered medium-uncentered columns">
		<h3><strong>赛事日程表</strong></h3>
		<div class="row hide-for-small-only"></div>
		<div class="row show-for-small-only"></div>
	</div>
	<script>
		function addMonth(monthstr, calendar) {
			var monthItem = jQuery('<h3/>', {});
			monthItem.append("<strong>" + monthstr + "</strong>");
			monthItem.appendTo(calendar);
		}
		
		calendarlarge = $("#calendar div[class='row hide-for-small-only']");
	
		var starttime = moment("{{ startdate|date:"D d M Y" }}");
		var endtime = moment("{{ enddate|date:"D d M Y" }}");
		var bonussummary = {};
		var bonusobj = eval('{{ bonussummary|safe }}');
		for (var idx in bonusobj) {
			bonussummary[bonusobj[idx].starttime] = bonusobj[idx].bonus;
		}
		var summary = {};
		{% for k,v in matchsummary.items %}
		summary['{{ k }}'] = {{ v }};
		{% endfor %}
		var m = moment.utc([starttime.year(), starttime.month(), starttime.dates(), starttime.hour(), starttime.minute(), starttime.second()]);
		var selectedTimestamp = getParameterByName('s');
		if (selectedTimestamp != null) {
			var initialDay = moment.unix(selectedTimestamp);
			if (!(initialDay.unix() >= starttime.unix() && initialDay.unix() <= endtime.unix()))
				initialDay = null;
		}
		var thismonth = m.month();
		addMonth(m.lang('zh_CN').format('MMM'), calendarlarge);
		daysItem = jQuery('<dl/>', {class : 'sub-nav'});
		contentTemplate2 = "<select id=\"calendar-select\" class=\"large\">";
		for (var i = 0; i < {{ intervals }}; i++) {
			if (m.month() != thismonth) {
				daysItem.appendTo(calendarlarge);
				addMonth(m.lang('zh_CN').format('MMM'), calendarlarge);
				thismonth = m.month();
				daysItem = jQuery('<dl/>', {class : 'sub-nav'});
			}
			var dayItem = jQuery('<dd/>', {});
			if (initialDay != null) {
				if (m.date() == initialDay.date() && m.month() == initialDay.month())
					dayItem.attr('class', 'active');
			} else if (m.date() == starttime.date() && m.month() == starttime.month())
				dayItem.attr('class', 'active');
			contentTemplate = "<h3><a href=\"javascript:void(0);\" timestamp=\"" + m.unix() + "\">" + m.format('DD') + " " + m.format('dddd');
			contentTemplate2 += "<h3><option value=\"" + m.unix() + "\">" + m.lang('zh_CN').format('MMMDD dddd');
				var formattedday = m.format("YYYY-MM-DD");
			if (formattedday in summary) {
				contentTemplate += "<sub><span data-tooltip=\"\" class=\"has-tip tip-top noradius\" title=\"当日比赛场数\">" + summary[formattedday] + "</span></sub>";
				contentTemplate2 += " (" + summary[formattedday] + ")";
			}
			if (formattedday in bonussummary) {
				contentTemplate += "<span data-tooltip=\"\" class=\"has-tip tip-top noradius\" title=\"奖金最高的比赛\"><sup><img src=\"{% static "images/bonus.jpeg" %}\"><sup></span>";
			}
			contentTemplate += "</a>" + "</h3>";
			contentTemplate2 += "</option></h3>";
			dayItem.append(contentTemplate);
			dayItem.appendTo(daysItem);
			m.add('days', 1);
		}
		contentTemplate2 += "</select>";
		daysItem.appendTo(calendarlarge);
		$("#calendar div[class='row show-for-small-only']").append(contentTemplate2);
	</script>
	<div id="map_matches" class="medium-8 columns">
		<br>
		<div class="row show-for-medium-up">
			<div id="baidumap" 
				style="overflow: hidden; margin: 0; height: 250px;"></div>
		</div>
		<!--div class="row"><h3 style="color:#FF9900"><strong>俱乐部赛事</strong></h3></div--><br>
		<div class="row">
				<div id="matchlist" class="large-12 columns">
				  	<script>
				  	var map = initialMap("baidumap");
				    MATCH_URL = "{% url match_detail '000' %}";
				    ACTIVITY_URL = "{% url activity_detail '000' %}";
				    ENROLL_URL = "{% url match_enroll '000' %}";
					{% if matches|length > 0 %}
						matches = eval(jsonescape('{{ matches|matchtojsonwithenroll:user|safe }}'));
						addMatchItems_v2(matches);
					{% else %}
			           	createNoMatch();
					{% endif %}
					</script>
				</div>
		</div>
	</div>
	<div id="newsfeed" class="medium-2 columns">
			<div class="row">
				<div class="large-11 large-centered columns">
					<br>
					<div class="row"><h3><font size =+1><strong>最新俱乐部赛事动态</strong></font></h3></div>
					<div class="row"><br></div>
					<div class="row"><p>关注微信公众帐号(pktaiqiu)，3月21日至3月31日期间参与活动，获取免费打球券，叫上你的朋友一起免费打台球。微博转发本次活动，并且@我为台球狂网_pktaiqiu，还有更多惊喜等着您。</p></div>
					<div class="row"><br/><br/><img src="http://billiardsalbum.bcs.duapp.com/2014/03/qrcode_for_logo.jpg"></div>
					<div class="row"><a href="#" data-dropdown="drop2">欢迎关注“我为台球狂”微信公众帐号:pktaiqiu</a></div>
					<div id="drop2" data-dropdown-content class="f-dropdown content">
  					<p>登录微信->进入“发现”菜单页面->点击“扫一扫”</p>
					</div>
					</div>
				</div>
			</div>
	</div>
{% endblock %}
{% block foundationscript %}
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/{{FOUNDATION_VER}}/js/foundation/foundation.magellan.min.js"></script>
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/{{FOUNDATION_VER}}/js/foundation/foundation.tooltip.min.js"></script>
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/{{FOUNDATION_VER}}/js/foundation/foundation.clearing.min.js"></script>
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/{{FOUNDATION_VER}}/js/foundation/foundation.dropdown.min.js"></script>
{% endblock %}
{% block script %}
	<script>
		var mypoint = null;
		$(document).ready(
				function mylocation() {
				    var geolocation = new BMap.Geolocation();
				    geolocation.getCurrentPosition(function(r){
				        if(this.getStatus() == BMAP_STATUS_SUCCESS){
                           	mypoint = r.point;
				            addMyLocation(mypoint);
                           	updateDistance(mypoint);
                           	addCustomToolbar(map, mypoint);
				            if ($("#nomatch").length == 1 && map.getBounds().containsPoint(r.point)) {
				            	map.panTo(r.point);
				            }
				        }
				        else {
				            //TODO
				        }
				    },{enableHighAccuracy: false});
				});

		$("dl dd a").click(function() {
			selectedItem = $(this);
			timestamp = selectedItem.attr('timestamp');
			selecteddate = moment(timestamp);
			$.ajax({
				url : "{% url match_map 'map' %}",
				data : {'f':'json', 'starttime':timestamp, 'endtime': selecteddate.add('days', 1).unix()},
				dataType : 'json',
				success : function(data)
				{
					$("dl dd.active").each(function() {
						$(this).removeClass("active");
					});
					selectedItem.parents("dd").attr('class', 'active');
					newloc = setGetParameter(window.location.pathname, 's', timestamp);
					window.history.pushState({ path: newloc }, '', newloc);
					addMatchItems_v2(data);
				}
			});
		});
		$('#calendar-select').change(function(){
			timestamp = $('#calendar-select').val();
			selecteddate = moment(timestamp);
			$.ajax({
				url : "{% url match_map 'map' %}",
				data : {'f':'json', 'starttime':timestamp, 'endtime': selecteddate.add('days', 1).unix()},
				dataType : 'json',
				success : function(data)
				{
					newloc = setGetParameter(window.location.pathname, 's', timestamp);
					window.history.pushState({ path: newloc }, '', newloc);
					addMatchItems_v2(data);
				}
			});
	    });
	</script>
{% endblock %}
