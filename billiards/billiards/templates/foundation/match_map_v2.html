{% extends "foundation/base.html" %}
{% block header %}
{% load staticfiles %}
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=5aaddbae69513573cd7f693bbdcbe12a"></script>
<script src="{% static "js/moment-with-langs.min.js" %}"></script>
<script language="javascript">var STATIC_URL = "{{ STATIC_URL|escapejs }}";</script>
<script src="{% static "js/map.js" %}?{{buildid}}"></script>
<script src="{% static "js/map_v2.js" %}?{{buildid}}"></script>
<link rel="stylesheet" href="{% static "css/map.css" %}?{{buildid}}">
{% endblock %}
{% load extras %}
{% block content %}
	<div id="calendar" class="medium-2 columns">
					<script>
						function addMonth(monthstr) {
							var monthItem = jQuery('<div/>', {class : 'row'});
							monthItem.append("<h5 style=color:#FF9900;><strong>赛事日程表</strong></h5>")
							monthItem.append("<h3 style=color:#FF9900><strong>" + monthstr + "</strong></h3>");
							monthItem.appendTo($("#calendar"));
						}

						var starttime = moment("{{ startdate|date:"D d M Y" }}");
						var endtime = moment("{{ enddate|date:"D d M Y" }}");
						var bonussummary = {};
						var bonusobj = eval('{{ bonussummary|safe }}');
						for (var idx in bonusobj) {
							bonussummary[bonusobj[idx].starttime] = bonusobj[idx].bonus;
						}
						var summary = {};
						{% for k,v in matchsummary.items %}
						summary['{{ k }}'] = {{ v }};
						{% endfor %}
						var m = moment();
						var thismonth = m.month();
						addMonth(m.lang('zh_CN').format('MMM'));
						daysItem = jQuery('<dl/>', {class : 'sub-nav'});
						for (var i = 0; i < {{ intervals }}; i++) {
							if (m.month() != thismonth) {
								daysItem.appendTo($("#calendar"));
								addMonth(m.lang('zh_CN').format('MMM'));
								thismonth = m.month();
								daysItem = jQuery('<dl/>', {class : 'sub-nav'});
							}
							var dayItem = jQuery('<dd/>', {});
							if (m.date() == starttime.date() && m.month() == starttime.month())
								dayItem.attr('class', 'active');
							contentTemplate = "<h4><a href=\"javascript:void(0);\" timestamp=\"" + m.valueOf() + "\">" + "<p class=\"calendar\">" + m.format('DD') ;
		 					var formattedday = m.format("YYYY-MM-DD");
							if (formattedday in summary) {
								contentTemplate += "<sub><span data-tooltip=\"\" class=\"has-tip tip-top noradius\" title=\"当日比赛场数\">" + summary[formattedday] + "</span></sub>";
							}
							if (formattedday in bonussummary) {
								contentTemplate += "<span data-tooltip=\"\" class=\"has-tip tip-top noradius\" title=\"奖金最高的比赛\"><sup>\
									<img src=\"{% static "images/bonus.jpeg" %}\"><sup></span>";
							}
							contentTemplate += "<em>" + m.format('dddd') + "</em>" + "</p>" + "</a>" + "</h4>";
							dayItem.append(contentTemplate);
							dayItem.appendTo(daysItem);
							m.add('days', 1);
						}
						daysItem.appendTo($("#calendar"));
						</script>
	</div>
	<div id="map_matches" class="medium-8 columns">
		<br>
		<div class="row show-for-medium-up">
			<div id="baidumap" 
				style="overflow: hidden; margin: 0;"></div>
		</div>
		<div class="row"><h3 style="color:#FF9900"><strong>俱乐部赛事</strong></h3></div>
		<div class="row">
				<div id="matchlist" class="large-12 columns">
				  	<script>
				  	var map = initialMap("baidumap");
				    MATCH_URL = "{% url match_detail '000' %}";
				    ENROLL_URL = "{% url match_enroll '000' %}";
					{% if matches|length > 0 %}
						matches = eval(jsonescape('{{ matches|matchtojson|safe }}'));
						addMatchItems_v2(matches);
					{% else %}
			           	createNoMatch();
					{% endif %}
					</script>
				</div>
		</div>
	</div>
	<div id="newsfeed" class="medium-2 columns">
			<div class="row">
				<div class="large-11 large-centered columns">
					<br>
					<div class="row"><h3 style="color:#FF9900"><font size =+1><strong>最新俱乐部赛事动态</strong></font></h3></div>
					<div class="row"><br></div>
					<div class="row"><p style="color:#FF9900">2013年12月9日，网站第一次内部测试</p></div>
					<div class="row"><br/><br/></div>
				</div>
			</div>
	</div>
{% endblock %}
{% block foundationscript %}
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/5.0.2/js/foundation/foundation.magellan.min.js"></script>
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/5.0.2/js/foundation/foundation.tooltip.min.js"></script>
    <script src="http://cdnjscn.b0.upaiyun.com/libs/foundation/5.0.2/js/foundation/foundation.clearing.min.js"></script>
{% endblock %}
{% block script %}
	<script>
		var mypoint = null;
		$(document).ready(
				function mylocation() {
				    $("#baidumap").css("height", 250);
				    var geolocation = new BMap.Geolocation();
				    geolocation.getCurrentPosition(function(r){
				        if(this.getStatus() == BMAP_STATUS_SUCCESS){
                           	mypoint = r.point;
				            addMyLocation(mypoint);
                           	updateDistance(mypoint);
                           	addCustomToolbar(map, mypoint);
				            if ($("#nomatch").length == 1 && map.getBounds().containsPoint(r.point)) {
				            	map.panTo(r.point);
				            }
				        }
				        else {
				            //TODO
				        }
				    },{enableHighAccuracy: false});
				});

		$("dl dd a").click(function() {
			selectedItem = $(this);
			timestamp = selectedItem.attr('timestamp');
			selecteddate = moment(timestamp);
			$.ajax({
				url : "{% url match_map 'map' %}",
				data : {'f':'json', 'starttime':timestamp, 'endtime': selecteddate.add('days', 1).valueOf()},
				dataType : 'json',
				success : function(data)
				{
					$("dl dd.active").each(function() {
						$(this).removeClass("active");
					});
					selectedItem.parents("dd").attr('class', 'active');
					addMatchItems_v2(data);
				}
			});
		});
	</script>
{% endblock %}
