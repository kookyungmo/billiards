{% extends "foundation/wechat/base.html" %}
{% load url from future %} 
{% block rightcontent %}
<div class="small-12 columns">
<h1>新用户统计</h1>
<hr>
<form id="reportForm" data-abide="ajax">
  <fieldset>
  	<legend>设置报表时间范围</legend>
    
    <div class="row">
      <div class="medium-6 columns">
		<label for="startdate">开始日期<small>*</small></label>
        <input type="date" id="startdate" placeholder="2014-01-30" required>
        <small class="error">请输入有效的日期</small>
      </div>
      <div class="medium-6 columns">
		<label for="enddate">结束日期<small>*</small></label>
        <input type="date" id="enddate" placeholder="2014-01-30" required>
        <small class="error">请输入有效的日期</small>
      </div>
    </div>

    <div class="row">
      <div id="errorMsg" class="large-12 columns hide">
       	<div data-alert class="alert-box warning round">
		</div>
      </div>
    </div>

    <div class="row">
      <div class="large-12 columns">
        <button type="submit" class="medium button green">查询</button>
      </div>
    </div>
  </fieldset>
</form>
<div id="reporttable">
</div>
</div>
{% endblock %} 
{% block script %}
<script>
function refreshData(data) {
	$("#reporttable").children().remove();
	if (data.length > 0) {
		var tableobj = jQuery('<table/>', {
		});
		contentTemplate ="<thead>"
			+ "<tr>"
			+ "<th width=\"200\">用户id</th>"
			+ "<th width=\"300\">关注日期</th>"
			+ "<th width=\"300\">是否首次关注</th>"
			+ "<th width=\"300\">是否已取消关注</th>"
			+ "<th width=\"300\">取消关注日期</th>"
			+ "</tr></thead><tbody>";
		for (idx in data) {
			contentTemplate += "<tr>"
				+ "<td>" + data[idx].fields.userid + "</td>"
				+ "<td>" + getFormattedTimeToDate(data[idx].fields.receivedtime) + "</td>"
				+ "<td>" + (data[idx].fields.firstjoin ? "是" : "否") + "</td>";
			if (data[idx].fields.unsubscribed == true) {
				contentTemplate += "<td>是</td>"
					+ "<td>" + data[idx].fields.unsubscribedDate + "</td>";
			} else {
				contentTemplate += "<td>否</td>"
					+ "<td>" + '' + "</td>";
			}
			contentTemplate += "</tr>";
		}
		contentTemplate += "</tbody>";
		tableobj.append(contentTemplate);
		tableobj.appendTo('#reporttable');
	} else {
		var preobj = jQuery('<pre/>', {
		});
		content = "<code class=\"language-html\"><h2>此时间段没有新关注用户。</h2></code>";
		preobj.append(content);
		preobj.appendTo('#reporttable');
	}
}
$("#reportForm").on('valid', function() {
	$("#errorMsg").addClass("hide");
	startdate = moment($("#startdate").val()).tz("{{ TIME_ZONE }}");
	enddate = moment($("#enddate").val()).tz("{{ TIME_ZONE }}");
	$.ajax({
		data : {
			'startdate': startdate.valueOf(),
			'enddate': enddate.valueOf(),
			},
			url : "{% url 'wechat_activity_report_newuser' %}",
			type: 'POST',
		dataType : 'json',
		success : function(data) {
			refreshData(data);
		},
		error : function(jqXHR, textStatus, errorThrown) {
			console.log(textStatus, errorThrown);
			$("#errorMsg .alert-box").text("网络错误，请重试。");
			$("#errorMsg").removeClass("hide");
		}
	});
});
moment.tz.add({
    "zones": {
        "Asia/Chongqing": [
            "7:6:20 - LMT 1928 7:6:20",
            "7 - LONT 1980_4 7",
            "8 PRC C%sT"
        ]
    },
    "rules": {
        "PRC": [
            "1986 1986 4 4 7 0 0 1 D",
            "1986 1991 8 11 0 0 0 0 S",
            "1987 1991 3 10 0 0 0 1 D"
        ]
    },
    "links": {}
});
</script>
{% endblock %}
